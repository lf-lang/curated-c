"use strict";(globalThis.webpackChunkdocusaurus_classic_typescript=globalThis.webpackChunkdocusaurus_classic_typescript||[]).push([[3109],{11349:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});var t=i(74848),r=i(28453);const o={title:"FlexPRET",description:"Developing LF Programs for FlexPRET."},l="Overview",s={id:"embedded/flexpret",title:"FlexPRET",description:"Developing LF Programs for FlexPRET.",source:"@site/docs/embedded/flexpret.mdx",sourceDirName:"embedded",slug:"/embedded/flexpret",permalink:"/docs/next/embedded/flexpret",draft:!1,unlisted:!1,editUrl:"https://github.com/lf-lang/lf-lang.github.io/tree/master/docs/embedded/flexpret.mdx",tags:[],version:"current",frontMatter:{title:"FlexPRET",description:"Developing LF Programs for FlexPRET."},sidebar:"handbookSidebar",previous:{title:"nRF52",permalink:"/docs/next/embedded/nRF52"},next:{title:"Contributing",permalink:"/docs/next/developer/contributing"}},d={},a=[{value:"Development environment setup",id:"development-environment-setup",level:2},{value:"FlexPRET build",id:"flexpret-build",level:2},{value:"Lingua Franca on FlexPRET",id:"lingua-franca-on-flexpret",level:2},{value:"Interrupt on expire",id:"interrupt-on-expire",level:2},{value:"Temporal isolation",id:"temporal-isolation",level:2},{value:"Building FlexPRET with another configuration",id:"building-flexpret-with-another-configuration",level:2},{value:"Environment not set up",id:"environment-not-set-up",level:2},{value:"FlexPRET not installed to SDK",id:"flexpret-not-installed-to-sdk",level:2},{value:"Instruction memory full",id:"instruction-memory-full",level:2},{value:"Bootloader not found",id:"bootloader-not-found",level:2},{value:"Hardware vs. software configuration mismatch",id:"hardware-vs-software-configuration-mismatch",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"overview",children:"Overview"})}),"\n",(0,t.jsxs)(n.p,{children:["FlexPRET is a precision-timed (PRET) machine designed for mixed-criticality systems. As of 2024, PRET machines are an open field of research. Refer to its ",(0,t.jsx)(n.a,{href:"https://github.com/pretis/flexpret",children:"github page"})," for more in-depth information. FlexPRET either needs to be emulated or run on a Field-Programmable Gate Array  (FPGA). In this guide we will show you how to pair FlexPRET with Lingua Franca, leaving you with precise software execution."]}),"\n",(0,t.jsxs)(n.p,{children:["As a developer, you should be aware of a significant difference between FlexPRET's notion of threads versus other platforms. FlexPRET uses fined-grained ",(0,t.jsx)(n.em,{children:"hardware"})," threads, as opposed to the usual (software) threads. This means that if multiple threads are running, they can swap every clock cycle. In addition, hardware threads are designed to be isolated, meaning the execution time of one thread will not affect the execution time of another, as opposed to concurrent software threads. Since the threads are implemented in hardware, FlexPRET can only have a maximum of eight."]}),"\n",(0,t.jsx)(n.h1,{id:"getting-started",children:"Getting started"}),"\n",(0,t.jsx)(n.h2,{id:"development-environment-setup",children:"Development environment setup"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["We start out by setting up a development environment. Clone the\n",(0,t.jsx)(n.code,{children:"lf-flexpret-template"})," from Github:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"git clone --recurse-submodules https://github.com/lf-lang/lf-flexpret-template lf-flexpret-workspace && cd lf-flexpret-workspace\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["Source the ",(0,t.jsx)(n.code,{children:"env.bash"})," to set up necessary environment variables. You will need to do this every time, so it could be a good idea to add this to your ",(0,t.jsx)(n.code,{children:"~/.bashrc"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"flexpret-build",children:"FlexPRET build"}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Now we will build the FlexPRET emulator. Step into the FlexPRET directory and build the default configuration with ",(0,t.jsx)(n.code,{children:"cmake"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd $FP_PATH\ncmake -B build && cd build && make\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsx)(n.li,{children:"You should now install FlexPRET's hardware configuration to the software development kit (SDK). This provides the SDK with necessary information such as the amount of data memory available."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"make install\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsx)(n.li,{children:"Next, step into the SDK and compile it. This step is strictly speaking not necessary, but it is good to know the system works as expected."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd $FP_SDK_PATH\ncmake -B build && cd build && make && ctest\n"})}),"\n",(0,t.jsx)(n.h2,{id:"lingua-franca-on-flexpret",children:"Lingua Franca on FlexPRET"}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Step back to the top-level directory and compile a sample LF application."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"lfc src/HelloWorld.lf\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"7",children:["\n",(0,t.jsx)(n.li,{children:"Run the compiled program on the FlexPRET emulator."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"./bin/HelloWorld\n"})}),"\n",(0,t.jsxs)(n.p,{children:["(This is just a ",(0,t.jsx)(n.code,{children:"bash"})," script that runs the emulator and passes the correct program binary file to it underneath the hood.)"]}),"\n",(0,t.jsxs)(n.ol,{start:"8",children:["\n",(0,t.jsx)(n.li,{children:"Verify that you see the expected output"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[0]: ---- Start execution ----\n[0]: Environment 0: ---- Intializing start tag\n[0]: Environment 0: ---- Spawning 1 workers.\n[1]: Hello world from FlexPRET\n[1]: Goodbye\n"})}),"\n",(0,t.jsxs)(n.p,{children:["(The ",(0,t.jsx)(n.code,{children:"[<n>]"})," means hardware thread ",(0,t.jsx)(n.code,{children:"n"})," is printing.)"]}),"\n",(0,t.jsx)(n.h1,{id:"flexpret-specific-features",children:"FlexPRET specific features"}),"\n",(0,t.jsxs)(n.p,{children:["Some of FlexPRET's specific features are highlighted in the sample programs. These include ",(0,t.jsx)(n.code,{children:"interrupt on expire"}),", which triggers an interrupt at some scheduled point in time and temporal isolation of hardware threads (i.e., isolated in timing)."]}),"\n",(0,t.jsx)(n.h2,{id:"interrupt-on-expire",children:"Interrupt on expire"}),"\n",(0,t.jsxs)(n.p,{children:["The sample code is available in ",(0,t.jsx)(n.code,{children:"src/InterruptExpire.lf"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Run the application like so:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"lfc src/InterruptExpire.lf && ./bin/InterruptExpire\n"})}),"\n",(0,t.jsx)(n.h2,{id:"temporal-isolation",children:"Temporal isolation"}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.code,{children:"src/multi-threaded/Isolation.lf"})," for the sample application. The application runs a hardware thread in the background of an LF reactor that triggers every 50 milliseconds. The interrupt handler runs a long ",(0,t.jsx)(n.code,{children:"for"})," loop. On other platforms, the interrupt handler would distrup the timing of the LF reaction. But due to temporal isolation, the LF reaction's timing is unaffected by the interrupts."]}),"\n",(0,t.jsx)(n.p,{children:"Run the application like so:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"lfc src/multi-threaded/Isolation.lf && ./bin/Isolation\n"})}),"\n",(0,t.jsx)(n.h2,{id:"building-flexpret-with-another-configuration",children:"Building FlexPRET with another configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Refer to the ",(0,t.jsx)(n.a,{href:"https://github.com/pretis/flexpret?tab=readme-ov-file#configuration",children:"FlexPRET docs"})," for more information on how to run a non-default and custom FlexPRET configuration."]}),"\n",(0,t.jsx)(n.h1,{id:"flexpret-on-fpga",children:"FlexPRET on FPGA"}),"\n",(0,t.jsxs)(n.p,{children:["It is possible to realize FlexPRET on a Field-Programmable Gate Array (FPGA). Refer to ",(0,t.jsx)(n.a,{href:"https://github.com/pretis/flexpret?tab=readme-ov-file#running-on-fpga",children:"the docs"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Please note that for FPGA, only hardware thread 0 is connected to a UART peripheral, meaning only hardware thread 0 can print using that."}),"\n",(0,t.jsx)(n.h1,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h2,{id:"environment-not-set-up",children:"Environment not set up"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"lfc: warning: No FP_PATH environment variable found\nlfc: warning: No FP_SDK_PATH environment variable found\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You probably forgot to ",(0,t.jsx)(n.code,{children:"source env.bash"})," or ",(0,t.jsx)(n.code,{children:"source env.fish"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"flexpret-not-installed-to-sdk",children:"FlexPRET not installed to SDK"}),"\n",(0,t.jsx)(n.p,{children:"This message means that the SDK did not find a FlexPRET installation."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Could not find\n  <path to workspace>/lf-flexpret-workspace/flexpret/sdk/flexpret/fp-emu.\n  Please build FlexPRET and install it here with `cmake --install` to\n  continue.\n"})}),"\n",(0,t.jsx)(n.p,{children:"In this case, you need to step into the FlexPRET directory, build FlexPRET (if\nnot built already) and install it to the SDK."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd $FP_PATH\ncmake -B build && cd build && make all install\n"})}),"\n",(0,t.jsx)(n.h2,{id:"instruction-memory-full",children:"Instruction memory full"}),"\n",(0,t.jsx)(n.p,{children:"An error that looks like this means your program (i.e., your instructions) are\ntoo large to fit inside the instruction memory."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"/opt/riscv/lib/gcc/riscv32-unknown-elf/11.1.0/../../../../riscv32-unknown-elf/bin/ld: HelloWorld section `.text' will not fit in region `ROM'\n/opt/riscv/lib/gcc/riscv32-unknown-elf/11.1.0/../../../../riscv32-unknown-elf/bin/ld: region `ROM' overflowed by 70664 bytes\n"})}),"\n",(0,t.jsx)(n.p,{children:"There are two possible solutions to this issue:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Reduce the size of your program. ",(0,t.jsx)(n.code,{children:"printf"})," is notorious for taking up a lot of\nspace, so consider replacing it with a lower footprint version (or nothing at all). Tip: To inspect\nwhat takes up space in your final executible, use ",(0,t.jsx)(n.code,{children:"nm"}),", like so:\n",(0,t.jsx)(n.code,{children:"nm HelloWorld --size-sort"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Increase the size of the instruction memory. This is done in FlexPRET's\nconfigs (see ",(0,t.jsx)(n.a,{href:"https://github.com/pretis/flexpret?tab=readme-ov-file#configuration",children:"FlexPRET's README"}),"). This is easily\ndone when emulating FlexPRET, but might not be so simple when realizing the design on an FPGA."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"bootloader-not-found",children:"Bootloader not found"}),"\n",(0,t.jsxs)(n.p,{children:["This error should only occur if you have specified ",(0,t.jsx)(n.code,{children:"fpga"})," in the board target property. It means that you do not have not built the bootloader in the FlexPRET SDK."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"/opt/riscv/lib/gcc/riscv32-unknown-elf/11.1.0/../../../../riscv32-unknown-elf/bin/ld: cannot open linker script file bootloader.ld: No such file or directory\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The solution is to build the SDK; it will build the bootloder and generate a ",(0,t.jsx)(n.code,{children:"bootloader.ld"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd $FP_SDK_PATH\ncmake -B build && cd build && make\n"})}),"\n",(0,t.jsx)(n.h2,{id:"hardware-vs-software-configuration-mismatch",children:"Hardware vs. software configuration mismatch"}),"\n",(0,t.jsx)(n.p,{children:"This error occurs if the configuration used to build FlexPRET does not match the hardware configuration installed to FlexPRET's SDK."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Reset_Handler: 165: Abort:[0]: Hardware and software configuration mismatch (0xef49961d vs. 0x79d84635)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The solution is to rebuild FlexPRET and install its hardware configuration to the SDK with ",(0,t.jsx)(n.code,{children:"make install"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>s});var t=i(96540);const r={},o=t.createContext(r);function l(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);