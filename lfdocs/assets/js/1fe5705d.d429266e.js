"use strict";(globalThis.webpackChunkdocusaurus_classic_typescript=globalThis.webpackChunkdocusaurus_classic_typescript||[]).push([[12006],{23550:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>a,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var t=r(74848),i=r(28453);const s={title:"Zephyr",description:"Developing LF Programs for Zephyr RTOS."},o="Overview",l={id:"embedded/zephyr",title:"Zephyr",description:"Developing LF Programs for Zephyr RTOS.",source:"@site/versioned_docs/version-0.5.0/embedded/zephyr.mdx",sourceDirName:"embedded",slug:"/embedded/zephyr",permalink:"/docs/0.5.0/embedded/zephyr",draft:!1,unlisted:!1,editUrl:"https://github.com/lf-lang/lf-lang.github.io/tree/master/versioned_docs/version-0.5.0/embedded/zephyr.mdx",tags:[],version:"0.5.0",frontMatter:{title:"Zephyr",description:"Developing LF Programs for Zephyr RTOS."},sidebar:"handbookSidebar",previous:{title:"Arduino",permalink:"/docs/0.5.0/embedded/arduino"},next:{title:"RP2040",permalink:"/docs/0.5.0/embedded/rp2040"}},d={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Setting up the LF Zephyr workspace",id:"setting-up-the-lf-zephyr-workspace",level:2},{value:"Workspace organization",id:"workspace-organization",level:2},{value:"Hello World!",id:"hello-world",level:2},{value:"Nrf52 blinky",id:"nrf52-blinky",level:2},{value:"Bare-bones Zephyr app",id:"bare-bones-zephyr-app",level:2},{value:"Timing in QEMU emulations",id:"timing-in-qemu-emulations",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Multiple Zephyr installations",id:"multiple-zephyr-installations",level:3}];function h(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"overview",children:"Overview"})}),"\n",(0,t.jsxs)(n.p,{children:["Lingua Franca's C-runtime supports the Zephyr RTOS. This enables developing and\nprogramming ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/boards/index.html",children:"hundreds"}),"\nof resource-constrained microcontrollers. In this guide we will see how LF\nprograms can be built, programmed and debugged both in emulation and on real\nhardware. When developing LF programs for Zephyr we use a ",(0,t.jsx)(n.code,{children:"west"}),"-centric\napproach. Using ",(0,t.jsx)(n.code,{children:"west"}),", which is the preferred build tool for Zephyr projects,\nrequires structuring the code base and development flow as expected by ",(0,t.jsx)(n.code,{children:"west"}),".\nWe use a ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/develop/west/workspaces.html#west-t3",children:"T3 Forest\nTopology"}),"\nfor our workspace. This means that we create a workspace where multiple\ndifferent LF Zephyr projects can be hosted together with a single copy of the\nZephyr RTOS sources."]}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Linux or macOS development system. (The guide is written for Linux)"}),"\n",(0,t.jsx)(n.li,{children:"nrf52 Development Kit (optional)"}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"getting-started",children:"Getting started"}),"\n",(0,t.jsxs)(n.p,{children:["The first step is to set up a proper Zephyr development environment. Follow the\nsteps in the ",(0,t.jsx)(n.strong,{children:"Install dependencies"})," and ",(0,t.jsx)(n.strong,{children:"Install Zephyr SDK"})," sections of the\nofficial ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/develop/getting_started/index.html",children:"Zephyr Getting Started\nGuide"}),".\nDo not perform the steps under ",(0,t.jsx)(n.strong,{children:"Get Zephyr and install Python\ndependencies"}),". These steps will be performed inside the LF Zephyr workspace we\nare going to create next."]}),"\n",(0,t.jsx)(n.h2,{id:"setting-up-the-lf-zephyr-workspace",children:"Setting up the LF Zephyr workspace"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Clone the template repository into a workspace directory of Zephyr projects"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"git clone https://github.com/lf-lang/lf-west-template lf-zephyr-workspace && cd lf-zephyr-workspace\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Setup and activate a virtual environment"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"python3 -m venv .venv\nsource .venv/bin/activate\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Install ",(0,t.jsx)(n.code,{children:"west"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"pip3 install west\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now ",(0,t.jsx)(n.code,{children:"west"})," is installed within a virtual environment. ",(0,t.jsx)(n.strong,{children:"This environment has to\nbe activated every time you want to use west with LF"})]}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsx)(n.li,{children:"Get the Zephyr source code"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"west update\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsx)(n.li,{children:"Export CMake packages for Zephyr"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"west zephyr-export\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Install Python dependencies"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"pip install -r deps/zephyr/scripts/requirements.txt\n"})}),"\n",(0,t.jsx)(n.h2,{id:"workspace-organization",children:"Workspace organization"}),"\n",(0,t.jsxs)(n.p,{children:["Now you should have the following installed:\n-",(0,t.jsx)(n.code,{children:"west"}),"; Verify with ",(0,t.jsx)(n.code,{children:"west boards"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Zephyr SDK located at ",(0,t.jsx)(n.code,{children:"/opt/zephyr-sdk-VERSION"})]}),"\n",(0,t.jsxs)(n.li,{children:["Zephyr RTOS pulled down to ",(0,t.jsx)(n.code,{children:"deps/zephyr"})]}),"\n",(0,t.jsxs)(n.li,{children:["A few example applications under ",(0,t.jsx)(n.code,{children:"apps/"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This workspace is meant to house all of your different LF Zephyr apps, as long\nas they are using the same version of Zephyr. Each app has to contain the\nfollowing:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"<app>\n\u251c\u2500\u2500 app.overlay\n\u251c\u2500\u2500 prj.conf\n\u251c\u2500\u2500 Kconfig\n\u2514\u2500\u2500 src\n    \u2514\u2500\u2500 MyApplication.lf\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Our custom west-extension will invoke ",(0,t.jsx)(n.code,{children:"lfc"})," and create a ",(0,t.jsx)(n.code,{children:"src-gen"})," directory\nstructured as a ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/develop/application/index.html",children:"Zephyr\napplication"}),".\nThis generated project can then be built, emulated or flashed by ",(0,t.jsx)(n.code,{children:"west"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"hello-world",children:"Hello World!"}),"\n",(0,t.jsx)(n.p,{children:'You should now be able to build and emulate a simple "Hello World" LF program:'}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd apps/HelloWorld\nlfc src/HelloWorld.lf -n\nwest build src-gen/HelloWorld -t run\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"HelloWorld.lf"})," has the target properties ",(0,t.jsx)(n.code,{children:'platform: "Zephyr"'})," and ",(0,t.jsx)(n.code,{children:"threading: false"}),". This tells ",(0,t.jsx)(n.code,{children:"lfc"})," to create a Zephyr-compatible CMake project. Then we\nuse ",(0,t.jsx)(n.code,{children:"west"})," to build the generated CMake project and to start an emulation."]}),"\n",(0,t.jsxs)(n.p,{children:["To enable ",(0,t.jsx)(n.strong,{children:"west-centric"})," development we have added a custom west command,\n",(0,t.jsx)(n.code,{children:"west lfc"}),". It is a wrapper around the original lfc but also copies the files\n",(0,t.jsx)(n.code,{children:"prj.conf"})," and ",(0,t.jsx)(n.code,{children:"Kconfig"})," into to generated project. It can also invoke ",(0,t.jsx)(n.code,{children:"west build"})," directly. The above example can be compiled and emulated with the\nfollowing command:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'west lfc src/HelloWorld.lf --build "-t run"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The string within the quotation marks after ",(0,t.jsx)(n.code,{children:"--build"})," is passed on to ",(0,t.jsx)(n.code,{children:"west build"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"nrf52-blinky",children:"Nrf52 blinky"}),"\n",(0,t.jsxs)(n.p,{children:["In this example we will program a simple Blinky program onto an nrf52dk. This\nrequires an actual nrf52 board and also the ",(0,t.jsx)(n.code,{children:"nrfjprog"})," utility is installed. See\nthe following installation guide\n",(0,t.jsx)(n.a,{href:"https://www.nordicsemi.com/Products/Development-tools/nrf-command-line-tools/download",children:"here"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'cd apps/NrfBlinky\nwest lfc src/NrfBlinky.lf --build "-p always -b nrf52dk_nrf52832"\nwest flash\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In this example we use the ",(0,t.jsx)(n.code,{children:"-p always"})," to tell west to do a clean build and ",(0,t.jsx)(n.code,{children:"-b nrf52dk_nrf52832"})," to target the nrf52dk. These parameters are west-specific so\nrefer to west documentation for more info. ",(0,t.jsx)(n.code,{children:"west flash"})," is used to interact with\n",(0,t.jsx)(n.code,{children:"nrfjprog"})," and flash the application into the dev-board."]}),"\n",(0,t.jsx)(n.h2,{id:"bare-bones-zephyr-app",children:"Bare-bones Zephyr app"}),"\n",(0,t.jsx)(n.p,{children:"We also have a simple example of a bare-bones Zephyr app. This requires a\nphysical board."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd apps/HelloZephyr\nwest build -b nrf52dk_nrf52832 -p always\nwest flash\n"})}),"\n",(0,t.jsx)(n.h1,{id:"zephyr-configuration-options",children:"Zephyr configuration options"}),"\n",(0,t.jsxs)(n.p,{children:["The Lingua Franca Zephyr platform depends on some specific ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/build/kconfig/index.html#",children:"Zephyr Kernel\nconfigurations"}),".\nFor instance, the Counter drivers must be linked with the application to provide\nhi-resolution timing. These required configurations are stored in a file called\n",(0,t.jsx)(n.code,{children:"prj_lf.conf"})," which ",(0,t.jsx)(n.code,{children:"lfc"})," generates into the ",(0,t.jsx)(n.code,{children:"src-gen"})," folder. You can provide\nyour own configurations through the following three files that ",(0,t.jsx)(n.code,{children:"west lfc"}),"\nexpects to find at the root of each app:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"prj.conf"}),", see ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/build/kconfig/setting.html#setting-symbols-in-configuration-files",children:"Seeting symbols in configuration files"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Kconfig"}),", see ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/build/kconfig/index.html",children:"Configuration system (Kconfig)"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"app.overlay"}),", see ",(0,t.jsx)(n.a,{href:"https://docs.zephyrproject.org/latest/build/dts/index.html#devicetree",children:"Devicetree"})]}),"\n"]}),"\n",(0,t.jsxs)(n.h1,{id:"the-west-lfc-command",children:["The ",(0,t.jsx)(n.code,{children:"west lfc"})," command"]}),"\n",(0,t.jsxs)(n.p,{children:["The custom ",(0,t.jsx)(n.code,{children:"lfc"})," west command has already been used in previous sections. It can\nbe inspected in ",(0,t.jsx)(n.code,{children:"scripts/lfc.py"}),". It invokes ",(0,t.jsx)(n.code,{children:"lfc"})," on the provided LF\nsource file. It also copies ",(0,t.jsx)(n.code,{children:"app.overlay"}),",",(0,t.jsx)(n.code,{children:"prj.conf"})," and ",(0,t.jsx)(n.code,{children:"Kconfig"})," into the\nsrc-gen directory before it, optionally, calls ",(0,t.jsx)(n.code,{children:"west build"})," on the resulting\nproject."]}),"\n",(0,t.jsxs)(n.p,{children:["Please see ",(0,t.jsx)(n.code,{children:"west lfc --help"})," for more information and the ",(0,t.jsx)(n.code,{children:"scripts/lfc.py"}),"."]}),"\n",(0,t.jsx)(n.h1,{id:"lfc-centric-development",children:"LFC-centric development"}),"\n",(0,t.jsxs)(n.p,{children:["In this guide we have shown how LF Zephyr apps can be developed in a\n",(0,t.jsx)(n.code,{children:"west"}),"-centric manner. It is also possible to target Zephyr in a ",(0,t.jsx)(n.code,{children:"lfc"}),"-centric\napproach. When you give ",(0,t.jsx)(n.code,{children:"lfc"})," a LF program with the ",(0,t.jsx)(n.code,{children:"platform"})," target property\nset to ",(0,t.jsx)(n.code,{children:"Zephyr"}),", it will generate a Zephyr project that can be built with\n",(0,t.jsx)(n.code,{children:"west"}),". For this to work, the environment variable ",(0,t.jsx)(n.code,{children:"ZEPHYR_BASE"})," must be set to\npoint to the Zephyr RTOS sources. To demonstrate this, create a simple example\nprogram:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'cat >> LfcCentricZephyr.lf << \'END\'\ntarget C {\n    platform: "Zephyr"\n}\nmain reactor{\n    reaction(startup) {=\n        lf_print("Hello World!");\n    =}\n}\nEND\n'})}),"\n",(0,t.jsxs)(n.p,{children:["If ",(0,t.jsx)(n.code,{children:"west"})," is installed in a virtual environment, activate it, and set up the\nenvironment. Assuming that the template is located at ",(0,t.jsx)(n.code,{children:"/home/lf-zephyr-workspace"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"source /home/lf-zephyr-workspace/.venv/bin/activate\nexport ZEPHYR_BASE=/home/lf-zephyr-workspace/deps/zephyr\nlfc LfcCentricZephyr.lf\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will create a Zephyr project at ",(0,t.jsx)(n.code,{children:"src-gen/LfcCentricZephyr"})," and invoke\nthe Zephyr toolchain to compile it. Since we have not specified any board,\nthe default, which is ",(0,t.jsx)(n.code,{children:"qemu_cortex_m3"}),", is used. We can run an emulation of\nthe program with:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cd src-gen/LfcCentricZephyr\nwest build -t run\n"})}),"\n",(0,t.jsx)(n.h1,{id:"debugging-lf-zephyr-programs-using-qemu-and-gdb",children:"Debugging LF Zephyr programs using QEMU and GDB"}),"\n",(0,t.jsx)(n.p,{children:"In this section we will see how a LF program can be debugged while running in\nQEMU emulation."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Compile ",(0,t.jsx)(n.code,{children:"HelloWorld.lf"})," for ",(0,t.jsx)(n.code,{children:"qemu_cortex_m3"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'cd apps/HelloWorld\nwest lfc src/HelloWorld.lf --build "-b qemu_cortex_m3 -p always"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Note that we here, unlike the very first example, explicitly tell ",(0,t.jsx)(n.code,{children:"lfc"})," that we\nare targeting a ",(0,t.jsx)(n.code,{children:"qemu_cortex_m3"})," platform. This is the default platform which is\nused unless another is specified. It is added here for clarity."]}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["In one terminal, start qemu as a debug server waiting for a local connection\nfrom ",(0,t.jsx)(n.code,{children:"gdb"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"ninja -C build debugserver\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["In another terminal start ",(0,t.jsx)(n.code,{children:"gdb"})," and connect to the qemu server. Load the\napplication image and run until main."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"/ZEPHYR_SDK_INSTALL_DIR/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb\n(gdb) target remote localhost:1234\n(gdb) file build/zephyr/zephyr.elf\n(gdb) b main\n(gdb) c\n"})}),"\n",(0,t.jsx)(n.p,{children:"From here you can step through the LF program. To get a more visual interface you can try:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"(gdb) tui enable\n"})}),"\n",(0,t.jsx)(n.h2,{id:"timing-in-qemu-emulations",children:"Timing in QEMU emulations"}),"\n",(0,t.jsxs)(n.p,{children:["The QEMU emulation is not cycle-accurate and implements optimizations such that\nif the system goes to sleep, like when the last active thread in the program\ncalls ",(0,t.jsx)(n.code,{children:"k_sleep()"}),", then the emulator fast-forwards time. This does not affect\nthe QEMU-emulation of the ",(0,t.jsx)(n.em,{children:"unthreaded"})," runtime since it implements sleeping\nbetween events using ",(0,t.jsx)(n.em,{children:"busy-waits"}),". However, the ",(0,t.jsx)(n.em,{children:"threaded"})," runtime sleeps\nbetween events using a call to ",(0,t.jsx)(n.code,{children:"k_cond_timedwait"})," which has the side-effect that\nQEMU fast-forwards time. This causes the emulation of threaded programs to\nappear as if the ",(0,t.jsx)(n.code,{children:"fast"})," target property was set to ",(0,t.jsx)(n.code,{children:"true"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"multiple-zephyr-installations",children:"Multiple Zephyr installations"}),"\n",(0,t.jsxs)(n.p,{children:["If the following warning is shown when invoking ",(0,t.jsx)(n.code,{children:"west lfc"})," or any other ",(0,t.jsx)(n.code,{children:"west"}),"\ncommand:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"WARNING: ZEPHYR_BASE=/path/to/zephyr in the calling environment will be used,\nbut the zephyr.base config option in /path/to/lf-west-template is \"deps/zephyr\"\nwhich implies a different ZEPHYR_BASE=/path/to/lf-west-template/deps/zephyr\nTo disable this warning in the future, execute 'west config --global zephyr.base-prefer env'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Then it means that you have multiple Zephyr repositories installed. We do not\nrecommend this as ",(0,t.jsx)(n.code,{children:"west"})," will link the application with the Zephyr found in the\nCMake package registry. Please refer to the Getting Started section to purge the\nsystem of old Zephyr installations."]})]})}function a(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var t=r(96540);const i={},s=t.createContext(i);function o(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);