"use strict";(globalThis.webpackChunkdocusaurus_classic_typescript=globalThis.webpackChunkdocusaurus_classic_typescript||[]).push([[3696],{28453:(e,n,o)=>{o.d(n,{R:()=>c,x:()=>d});var i=o(96540);const r={},t=i.createContext(r);function c(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(t.Provider,{value:n},e.children)}},38624:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>a});var i=o(74848),r=o(28453);const t={title:"Docker Support",description:"Building and running Lingua Franca programs using Docker"},c=void 0,d={id:"reference/docker-support",title:"Docker Support",description:"Building and running Lingua Franca programs using Docker",source:"@site/versioned_docs/version-0.11.0/reference/docker-support.mdx",sourceDirName:"reference",slug:"/reference/docker-support",permalink:"/docs/reference/docker-support",draft:!1,unlisted:!1,editUrl:"https://github.com/lf-lang/lf-lang.github.io/tree/master/versioned_docs/version-0.11.0/reference/docker-support.mdx",tags:[],version:"0.11.0",frontMatter:{title:"Docker Support",description:"Building and running Lingua Franca programs using Docker"},sidebar:"handbookSidebar",previous:{title:"Troubleshooting",permalink:"/docs/tools/troubleshooting"},next:{title:"Expressions",permalink:"/docs/reference/expressions"}},s={},a=[{value:"Where to find the Docker configuration files",id:"where-to-find-the-docker-configuration-files",level:2},{value:"Regular LF applications",id:"regular-lf-applications",level:3},{value:"Federated LF applications",id:"federated-lf-applications",level:3},{value:"Configuration options",id:"configuration-options",level:2},{value:"Option <code>builder-base</code>",id:"option-builder-base",level:3},{value:"Option <code>env-file</code>",id:"option-env-file",level:3},{value:"Option <code>no-build</code>",id:"option-no-build",level:3},{value:"Option <code>post-build-script</code>",id:"option-post-build-script",level:3},{value:"Option <code>pre-build-script</code>",id:"option-pre-build-script",level:3},{value:"Option <code>pre-run-script</code>",id:"option-pre-run-script",level:3},{value:"Option <code>runner-base</code>",id:"option-runner-base",level:3},{value:"Option <code>rti-image</code>",id:"option-rti-image",level:3},{value:"Option <code>docker-compose-override</code>",id:"option-docker-compose-override",level:3},{value:"Manually building and running",id:"manually-building-and-running",level:2},{value:"Using <code>docker build</code> and <code>docker run</code>",id:"using-docker-build-and-docker-run",level:3},{value:"Manually launching a federation",id:"manually-launching-a-federation",level:4},{value:"Create a network and launch RTI",id:"create-a-network-and-launch-rti",level:5}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["You will need to ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:"install Docker"})," in order to use this feature."]})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"C"}),", ",(0,i.jsx)(n.code,{children:"Cpp"}),", ",(0,i.jsx)(n.code,{children:"Python"}),", and ",(0,i.jsx)(n.code,{children:"TypeScript"})," target allow you to conveniently build and run your Lingua Franca code in a Docker container. To enable this feature, include the ",(0,i.jsx)(n.code,{children:"docker"})," property in your target specification, as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lf-c",children:"target C {\n    docker: true\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When Docker support is enabled, the produced target code will be built inside of a Docker container, and the executable produced in the ",(0,i.jsx)(n.code,{children:"bin"})," directory will invoke ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/compose/",children:"Docker Compose"})," in order to run the containerized application."]}),"\n",(0,i.jsx)(n.h2,{id:"where-to-find-the-docker-configuration-files",children:"Where to find the Docker configuration files"}),"\n",(0,i.jsx)(n.h3,{id:"regular-lf-applications",children:"Regular LF applications"}),"\n",(0,i.jsxs)(n.p,{children:["For an unfederated application ",(0,i.jsx)(n.code,{children:"src/Main.lf"}),", like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lf-c",children:'target C {\n  docker: true\n};\n\nmain reactor Main {\n  reaction (startup)  {=\n    printf("Hello World!\\n");\n  =}\n} \n'})}),"\n",(0,i.jsx)(n.p,{children:"the following extra Docker-related files are produced:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:".\n\u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u2514\u2500\u2500 Main\n...\n\u2514\u2500\u2500 src-gen\n    \u2514\u2500\u2500 Main\n        ...\n        \u251c\u2500\u2500 docker-compose.yml\n        \u251c\u2500\u2500 Dockerfile\n        ...\n"})}),"\n",(0,i.jsx)(n.h3,{id:"federated-lf-applications",children:"Federated LF applications"}),"\n",(0,i.jsxs)(n.p,{children:["A federated version of ",(0,i.jsx)(n.code,{children:"src/Main.lf"})," like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lf-c",children:'target C {\n  docker: true\n};\n\nreactor Hello {\n  reaction (startup)  {=\n    printf("Hello World!\\n");\n  =}\n}\n\nfederated reactor Main {\n    hello1 = new Hello();\n    hello2 = new Hello();\n} \n'})}),"\n",(0,i.jsx)(n.p,{children:"would produce the following Docker-related files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:".\n\u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u2514\u2500\u2500 Main\n\u251c\u2500\u2500 fed-gen\n\u2502\xa0\xa0 \u2514\u2500\u2500 Main\n|       ...\n\u2502\xa0\xa0     \u2514\u2500\u2500 src-gen\n\u2502\xa0\xa0         \u251c\u2500\u2500 docker-compose.yml\n\u2502\xa0\xa0         \u251c\u2500\u2500 federate__hello1\n\u2502\xa0\xa0         \u2502\xa0\xa0 ...\n\u2502\xa0\xa0         \u2502\xa0\xa0 \u251c\u2500\u2500 Dockerfile\n|           ...\n\u2502\xa0\xa0         \u2514\u2500\u2500 federate__hello2\n\u2502\xa0\xa0             ...\n\u2502\xa0\xa0             \u251c\u2500\u2500 Dockerfile\n...             ...\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configuration-options",children:"Configuration options"}),"\n",(0,i.jsxs)(n.p,{children:["You can further customize the generated Docker file through the ",(0,i.jsx)(n.code,{children:"docker"})," target property. Instead of just enabling Docker support using ",(0,i.jsx)(n.code,{children:"true"}),", specify configuration options in a dictionary."]}),"\n",(0,i.jsxs)(n.h3,{id:"option-builder-base",children:["Option ",(0,i.jsx)(n.code,{children:"builder-base"})]}),"\n",(0,i.jsxs)(n.p,{children:["You can specify a custom base image (used in the Docker ",(0,i.jsx)(n.code,{children:"FROM"})," command) for building as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  docker: {\n    builder-base: "ubuntu:latest"\n  }\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"builder-base"})," option replaces the ",(0,i.jsx)(n.code,{children:"FROM"})," option, which is no longer supported in version ",(0,i.jsx)(n.code,{children:"0.8.0"})," and on."]})}),"\n",(0,i.jsxs)(n.p,{children:["The default is ",(0,i.jsx)(n.code,{children:'"alpine:latest"'}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Note that the generated ",(0,i.jsx)(n.code,{children:"Dockerfile"})," uses a separate build and run stage. The ",(0,i.jsx)(n.code,{children:"builder-base"})," applies to the former and ",(0,i.jsx)(n.em,{children:"also"})," the latter, ",(0,i.jsx)(n.em,{children:"unless"})," the option ",(0,i.jsx)(n.code,{children:"runner-base"})," is specified."]}),"\n",(0,i.jsxs)(n.h3,{id:"option-env-file",children:["Option ",(0,i.jsx)(n.code,{children:"env-file"})]}),"\n",(0,i.jsxs)(n.p,{children:["Docker Compose has a feature that ",(0,i.jsxs)(n.a,{href:"https://docs.docker.com/compose/environment-variables/set-environment-variables/#use-the-env_file-attribute",children:["allows you to set environment variables using a ",(0,i.jsx)(n.code,{children:".env"})," file"]}),". The ",(0,i.jsx)(n.code,{children:"docker"})," target property has a configuration option that lets you specify such file to be used in the generated ",(0,i.jsx)(n.code,{children:"docker-compose.yml"}),". For example, point Docker Compose to an environment file called ",(0,i.jsx)(n.code,{children:"foo.env"}),", specify:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  docker: {\n    env-file: "foo.env"\n  }\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["In Docker, the attribute is named ",(0,i.jsx)(n.code,{children:"env_file"})," (with an underscore), but conforming to the formatting of Lingua Franca target properties, this option is named ",(0,i.jsx)(n.code,{children:"env-file"}),"."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-no-build",children:["Option ",(0,i.jsx)(n.code,{children:"no-build"})]}),"\n",(0,i.jsx)(n.p,{children:"If you only want to generated code and configuration files but do not want to the Lingua Franca to compiler also build the generated code in a container for you, you can disable it as follows:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"  docker: {\n    no-build: true\n  }\n"})}),"\n",(0,i.jsxs)(n.p,{children:["By default, ",(0,i.jsx)(n.code,{children:"no-build"})," is ",(0,i.jsx)(n.code,{children:"false"})," and hence building is enabled."]}),"\n",(0,i.jsxs)(n.h3,{id:"option-post-build-script",children:["Option ",(0,i.jsx)(n.code,{children:"post-build-script"})]}),"\n",(0,i.jsxs)(n.p,{children:["If any actions need to be performed at the end of the build stage (such as any cleanups or additional installation steps), you can put these in a shell script and pass it as an option in the ",(0,i.jsx)(n.code,{children:"docker"})," target property. Example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  docker: {\n    post-build-script: "path/to/post-build.sh"\n  }\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The given path should either be relative to the package root or relative to the ",(0,i.jsx)(n.code,{children:".lf"})," file in which the target property is given."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-pre-build-script",children:["Option ",(0,i.jsx)(n.code,{children:"pre-build-script"})]}),"\n",(0,i.jsxs)(n.p,{children:["If any actions need to be performed at the beginning of the build stage (such as setting environment variables), you can put these in a shell script and pass it as an option in the ",(0,i.jsx)(n.code,{children:"docker"})," target property. Example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  docker: {\n    pre-build-script: "path/to/pre-build.sh"\n  }\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The given path should either be relative to the package root or relative to the ",(0,i.jsx)(n.code,{children:".lf"})," file in which the target property is given."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-pre-run-script",children:["Option ",(0,i.jsx)(n.code,{children:"pre-run-script"})]}),"\n",(0,i.jsxs)(n.p,{children:["If any actions need to be performed (such as setting environment variables) at the beginning of the entrypoint in the run stage, you can put these in a shell script and pass it as an option in the ",(0,i.jsx)(n.code,{children:"docker"})," target property. Example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  docker: {\n    pre-run-script: "path/to/pre-run.sh"\n  }\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The given path should either be relative to the package root or relative to the ",(0,i.jsx)(n.code,{children:".lf"})," file in which the target property is given."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-runner-base",children:["Option ",(0,i.jsx)(n.code,{children:"runner-base"})]}),"\n",(0,i.jsxs)(n.p,{children:["To pick a base image for the run stage in the generated ",(0,i.jsx)(n.code,{children:"Dockerfile"}),", use the ",(0,i.jsx)(n.code,{children:"runner-base"})," option:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lf-c",children:'  docker: {\n    runner-base: "archlinux:latest"\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Note that this will ",(0,i.jsx)(n.em,{children:"not"})," affect the build stage. To change the base image of the build stage, use the ",(0,i.jsxs)(n.a,{href:"#option-builder-base",children:[(0,i.jsx)(n.code,{children:"builder-base"})," option"]}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["By default, ",(0,i.jsx)(n.code,{children:"runner-base"})," is ",(0,i.jsx)(n.code,{children:'"alpine:latest"'}),". However, if ",(0,i.jsx)(n.code,{children:"builder-base"})," is defined, then ",(0,i.jsx)(n.code,{children:"runner-base"})," defaults to the value that was assigned to ",(0,i.jsx)(n.code,{children:"builder-base"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["You can also use the builder stage as the base for the running stage (and inherit all the installed dependencies and created build artifacts). To do this, simply use ",(0,i.jsx)(n.code,{children:'runner-base: "builder"'}),"."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-rti-image",children:["Option ",(0,i.jsx)(n.code,{children:"rti-image"})]}),"\n",(0,i.jsxs)(n.p,{children:["To run a federated program, an RTI process must run to support it. By default, the RTI is built locally in a Docker image. This is equivalent to specifying ",(0,i.jsx)(n.code,{children:'rti-image: "rti:local"'}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["An alternative image to be pulled from DockerHub can be specified using the ",(0,i.jsx)(n.code,{children:"rti-image"})," entry.\nFor example, you can specify ",(0,i.jsx)(n.code,{children:'"lflang/rti:latest"'}),", an image that is available on DockerHub."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The value of the ",(0,i.jsx)(n.code,{children:"builder-base"}),", ",(0,i.jsx)(n.code,{children:"runner-base"}),", and ",(0,i.jsx)(n.code,{children:"rti-image"})," entry should follow Docker's ",(0,i.jsx)(n.code,{children:"<user-name>/<image-name>:<tag-name>"})," naming convention for image names. Docker will resolve the name and pull the image from your local registry, or, if it cannot be found, from DockerHub."]})}),"\n",(0,i.jsxs)(n.h3,{id:"option-docker-compose-override",children:["Option ",(0,i.jsx)(n.code,{children:"docker-compose-override"})]}),"\n",(0,i.jsxs)(n.p,{children:["If you want to set custom runtime parameters for docker, you can use the ",(0,i.jsx)(n.code,{children:"docker-compose-override"})," option. For example, you can set gpu support, shared memory usage, volume mounts etc."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lf-c",children:'  docker: {\n    docker-compose-override: "path/to/docker-compose-override.yml"\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The path points to your custom yaml file formatted as a docker-compose file. This file will be used to add to and override the default docker-compose file generated by the compiler following the ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/reference/cli/docker/compose/",children:"docker compose multiple file standard"}),". Specifically, the compiler generated docker-compose file and your custom docker compose file will be passed as ",(0,i.jsx)(n.code,{children:"-f"})," parameters to docker compose in order."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["The service names of your custom docker-compose file should match the service names of the compiler generated docker-compose file. Note that when your program is federated, a ",(0,i.jsx)(n.code,{children:"federate__"})," prefix is used for each service that brings up a federate. For example, if your program has a top-level reactor instance named ",(0,i.jsx)(n.code,{children:"a"}),", then its corresponding service name will be ",(0,i.jsx)(n.code,{children:"federate__a"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"manually-building-and-running",children:"Manually building and running"}),"\n",(0,i.jsxs)(n.p,{children:["The generated executable simply invokes ",(0,i.jsx)(n.code,{children:"docker compose up --abort-on-container-failure"}),", but this might not be what you want. Here are some guidelines for building and running manually.\nIf you instead want to build manually after code generation has completed, you can instruct to Lingua Franca compiler to skip building using the ",(0,i.jsx)(n.code,{children:"no-build"})," option in the ",(0,i.jsx)(n.code,{children:"docker"})," target property. More information can be found ",(0,i.jsx)(n.a,{href:"#option-no-build",children:"here"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"using-docker-build-and-docker-run",children:["Using ",(0,i.jsx)(n.code,{children:"docker build"})," and ",(0,i.jsx)(n.code,{children:"docker run"})]}),"\n",(0,i.jsxs)(n.p,{children:["You can build images and run containers in separate steps. First, change directory to ",(0,i.jsxs)(n.a,{href:"#where-to-find-the-docker-configuration-files",children:["the location of the ",(0,i.jsx)(n.code,{children:"Dockerfile"})]}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker build -t foo .\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will create a Docker image with tag ",(0,i.jsx)(n.code,{children:"foo"}),". The tag is required to be all lower-case letters. By convention, we advise using the LF source file name, converted to lower case."]}),"\n",(0,i.jsx)(n.p,{children:"You can then use this tag to run the image in a container:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker run -t --rm foo\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"-t"})," option creates a pseudo terminal, which is necessary for you to see any output produced by your program to ",(0,i.jsx)(n.code,{children:"stdout"}),". If your program also reads from ",(0,i.jsx)(n.code,{children:"stdin"}),", then you will need to give the ",(0,i.jsx)(n.code,{children:"-i"})," option as well, or combine the two as ",(0,i.jsx)(n.code,{children:"it"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"--rm"})," option is important. This removes the container upon completion of the run. If you omit this option, the container will continue to exist even after your program has terminated. You can alternatively remove the container after the run using ",(0,i.jsx)(n.code,{children:"docker rm"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If you wish for your program to run in the background, give a ",(0,i.jsx)(n.code,{children:"-d"}),' option as well (for "detached"). In this case, you will not see any output from your run.']}),"\n",(0,i.jsx)(n.p,{children:"The above run command can include any supported command-line arguments to the LF program. For example, to specify a logical timeout, you can do this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker run -t --rm foo --timeout 20 sec\n"})}),"\n",(0,i.jsx)(n.h4,{id:"manually-launching-a-federation",children:"Manually launching a federation"}),"\n",(0,i.jsx)(n.p,{children:"In addition to building the images and running each individual container, launching a federation requires a few additional steps."}),"\n",(0,i.jsx)(n.h5,{id:"create-a-network-and-launch-rti",children:"Create a network and launch RTI"}),"\n",(0,i.jsx)(n.p,{children:"To pull the RTI from DockerHub, run this command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker pull lflang/rti:rti\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now, create a named network on which to run your federation. For example, to create a network named ",(0,i.jsx)(n.code,{children:"lf"}),", do this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker network create lf\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can then launch the RTI on this network (do this in a separate terminal):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker run -t --rm --name rti --network lf lflang/rti:rti -n 2 -i 1234\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Here, the ",(0,i.jsx)(n.code,{children:"-n 2"})," indicates that the total number of federates is two and ",(0,i.jsx)(n.code,{children:"-i 1234"})," assigns an identifier for the federation."]}),"\n",(0,i.jsxs)(n.p,{children:["The federates ",(0,i.jsx)(n.code,{children:"foo"})," and ",(0,i.jsx)(n.code,{children:"bar"}),", the images of which have already been built, can be started using the following commands:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker run -t --rm --network lf foo\ndocker run -t --rm --network lf bar\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);